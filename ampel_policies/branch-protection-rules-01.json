{
    "id": "My Policy for Branch Protection",
    "meta": {
        "frameworks": [
            { "id": "MyOrg-Branch-Protection-Rules", "name": "MyOrg Branch Protection Rules" }
        ]
    },
    "policies": [
        {
            "id": "OSPS-QA-07.01",
            "meta": {
                "description": "VCS MUST require at least one non-author approval of changes to the primary branch",
                "controls": [ { "framework": "OSPS", "class": "QA", "id": "07" } ]
            },
            "tenets": [
                {
                    "id": "01",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"update\") : false",
                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "Direct pushes are disabled in default branch. PR required."
                    },
                    "error": {
                        "message": "Direct pushes are enabled so PRs are not required.",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Restrict updates\""
                    }
                },
                {
                    "id": "02",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"non_fast_forward\") : false",
                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "Force pushing is disabled in default branch."
                    },
                    "error": {
                        "message": "Force pushes can be sent to main branch",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Block force pushes\""
                    }
                },
                {
                    "id": "03",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"pull_request\" && rule.parameters.required_approving_review_count >= 1) : false",
                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "Minimum one non-author approval is required"
                    },
                    "error": {
                        "message": "PRs can be merged without peer review.",
                        "guidance": "Ensure the pull request rule requires at least one approving review."
                    }
                }
            ]
        },
        {
            "id": "OSPS-AC-03.02",
            "meta": {
                "description": "VCS MUST treat main branch deletion as a sensitive activity and require explicit confirmation of intent",
                "controls": [ { "framework": "OSPS", "class": "AC", "id": "03" } ]
            },
            "tenets": [
                {
                    "id": "02",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"deletion\") : false",
                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "Branch deletion is disabled on default branch"
                    },
                    "error": {
                        "message": "Branch delete protection is not enabled",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Restrict deletions\""
                    }
                }
            ]
        },
        {
            "id": "MYORG-01",
            "meta": {
                "description": "Require CODEOWNER approval before merging",
                "controls": [ { "framework": "MYORG", "class": "ORG", "id": "01" } ]
            },
            "tenets": [
                {
                    "id": "01",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"pull_request\" && rule.parameters.require_code_owner_review == true) : false",

                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "CODEOWNER approval is required before merging"
                    },
                    "error": {
                        "message": "CODEOWNER approval is not required before merging",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Require review from Code Owners\""
                    }
                }
            ]
        },
        {
            "id": "MYORG-02",
            "meta": {
                "description": "Require signed commits before merging",
                "controls": [ { "framework": "MYORG", "class": "ORG", "id": "02" } ]
            },
            "tenets": [
                {
                    "id": "01",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"required_signatures\") : false",

                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "Signed commits are required before merging"
                    },
                    "error": {
                        "message": "Signed commits are not required before merging",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Require signed commits\""
                    }
                }
            ]
        },
        {
            "id": "MYORG-03",
            "meta": {
                "description": "Ensure approvals are updated and compliant when changes are made",
                "controls": [ { "framework": "MYORG", "class": "ORG", "id": "03" } ]
            },
            "tenets": [
                {
                    "id": "01",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"pull_request\" && rule.parameters.dismiss_stale_reviews_on_push == true) : false",

                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "New, reviewable commits pushed will dismiss previous PR review approvals."
                    },
                    "error": {
                        "message": "Approvals are not dismissed when new commits are pushed.",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Dismiss stale pull request approvals when new commits are pushed\""
                    }
                },
                {
                    "id": "02",
                    "code": "has(predicates[0].data.values) ? predicates[0].data.values.exists(rule, rule.type == \"pull_request\" && rule.parameters.require_last_push_approval == true) : false",

                    "predicates": {
                        "types": ["http://github.com/carabiner-dev/snappy/specs/branch-rules.yaml"]
                    },
                    "assessment": {
                        "message": "The most recent push must be approved by someone other than the person who pushed it."
                    },
                    "error": {
                        "message": "The most recent reviewable push is not approved by someone other than the person who pushed it.",
                        "guidance": "Create a branch ruleset protecting your default branch and enable \"Require approval of the most recent reviewable push\""
                    }
                }
            ]
        }
    ]
}
